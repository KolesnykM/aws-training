AWSTemplateFormatVersion: 2010-09-09
Description: AWS CloudFormation Template To Create a DynamoDB

Parameters:
  HashKeyElementName:
    Type: String
    Default: ISBN
    Description: Hash Key Name
  HashKeyElementType:
    Type: String
    Default: S
    Description: Hash Key Type
Resources:
  EmployeeTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Books_Descriptions1
      AttributeDefinitions:
        - 
          AttributeName: !Ref HashKeyElementName
          AttributeType: !Ref HashKeyElementType
      KeySchema:
        - 
          AttributeName: !Ref HashKeyElementName
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: "vpc-ff35a094"
      GroupDescription: "Enable SSH access via port 22"
      SecurityGroupIngress:
        - CidrIp: "0.0.0.0/0"
          Description: "Allowed from anywhere"
          FromPort: "22"
          ToPort: "22"
          IpProtocol: "tcp"
        - CidrIp: "0.0.0.0/0"
          Description: "Allowed from anywhere"
          FromPort: "8443"
          ToPort: "8443"
          IpProtocol: "tcp"
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: "t2.micro"
      SecurityGroupIds:
        -
          !GetAtt InstanceSecurityGroup.GroupId
      KeyName: 'EC2Keypair'
      ImageId: ami-08962a4068733a2b6
      SubnetId: subnet-a6de62cd
      IamInstanceProfile: !Ref RootInstanceProfile
  RootRole:
    Type: "AWS::IAM::Role"
    Properties:
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AmazonSQSFullAccess"
        - "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
  RootInstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
        Path: "/"
        Roles:
          - Ref: "RootRole"
  MyS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: bucket-from-template-container
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  MyQueue:
    Type: AWS::SQS::Queue
    Properties:
      DelaySeconds: 0
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AmazonSQSFullAccess"
        - "arn:aws:iam::aws:policy/AWSLambdaExecute"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
  LambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          import json
          import boto3

          def lambda_handler(event, context):
              s3 = boto3.client("s3")

              data = json.loads(event["Records"][0]["body"])
              s3.put_object(Bucket=!GetAtt MyS3Bucket.name, Key="data.json", Body=json.dumps(data))
              return {
                  'statusCode': 200,
                  'body': json.dumps('Hello from Lambda!')
              }
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Runtime: Python 3.8
      Timeout: 60
      MemorySize: 128

    LambdaFunctionEventSourceMapping:
      Type: AWS::Lambda::EventSourceMapping
      Properties:
        BatchSize: 10
        Enabled: true
        EventSourceArn: !GetAtt MyQueue.Arn
        FunctionName: !GetAtt LambdaFunction.Arn
Outputs:
  Employee:
    Description: Table Created using this template.
    Value: !Ref EmployeeTable
